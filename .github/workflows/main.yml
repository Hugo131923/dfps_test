name: Build and Package DFPS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NDK_VERSION: r25b
  NDK_URL: https://dl.google.com/android/repository/android-ndk-r25b-linux.zip

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache NDK
      uses: actions/cache@v3
      id: ndk-cache
      with:
        path: android-ndk-${{ env.NDK_VERSION }}
        key: ${{ runner.os }}-ndk-${{ env.NDK_VERSION }}
    
    - name: Download NDK
      if: steps.ndk-cache.outputs.cache-hit != 'true'
      run: |
        wget -q ${{ env.NDK_URL }}
        unzip -q android-ndk-${{ env.NDK_VERSION }}-linux.zip
        rm android-ndk-${{ env.NDK_VERSION }}-linux.zip
    
    - name: Setup environment
      run: |
        echo "ANDROID_NDK=$(pwd)/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV
        echo "$(pwd)/android-ndk-${{ env.NDK_VERSION }}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
    
    - name: Build and package
      run: |
        chmod +x build.sh
        ./build.sh Release "make pack"
        echo "Build completed successfully!"
    
    - name: Upload module package
      uses: actions/upload-artifact@v4
      with:
        name: dfps-module
        path: build/package/dfps-magisk.zip
        retention-days: 7
    
    - name: Upload binary only
      uses: actions/upload-artifact@v4
      with:
        name: dfps-binary
        path: build/arm64/runnable/dfps
        retention-days: 7
