name: Build Complete DFPS Module

on: workflow_dispatch

jobs:
  build-module:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
        unzip -q android-ndk-r25b-linux.zip
        echo "ANDROID_NDK=$(pwd)/android-ndk-r25b" >> $GITHUB_ENV
    
    - name: Fix magisk directory structure
      run: |
        echo "准备 Magisk 模块目录..."
        # 确保 magisk/bin 目录存在
        mkdir -p magisk/bin
        
        # 如果模块文件不存在，创建基本结构
        if [ ! -f "magisk/module.prop" ]; then
          cat > magisk/module.prop << EOF
id=yc_dfps_custom
name=DFPS Custom (亮度修复版)
version=v1.0-custom
versionCode=20240110
author=$(git config user.name || echo "Custom User")
description=修复亮度逻辑，低亮度时锁定60Hz刷新率
EOF
        fi
        
        if [ ! -f "magisk/post-fs-data.sh" ]; then
          cat > magisk/post-fs-data.sh << 'EOF'
#!/system/bin/sh
# 设置权限
chmod 755 $MODPATH/bin/dfps
EOF
          chmod 755 magisk/post-fs-data.sh
        fi
    
    - name: Build and manual pack
      run: |
        chmod +x build.sh
        
        # 构建二进制
        echo "=== 构建二进制 ==="
        ./build.sh Release "make"
        
        # 查找构建的二进制
        DFPS_FILE=$(find . -name "dfps" -type f 2>/dev/null | head -1)
        
        if [ -n "$DFPS_FILE" ]; then
          echo "复制二进制到模块目录..."
          cp "$DFPS_FILE" magisk/bin/dfps
          chmod 755 magisk/bin/dfps
          
          # 复制许可证文件
          cp LICENSE magisk/ 2>/dev/null || echo "无 LICENSE 文件"
          cp NOTICE magisk/ 2>/dev/null || echo "无 NOTICE 文件"
          
          # 打包模块
          echo "=== 打包模块 ==="
          cd magisk
          zip -r ../dfps-magisk-module.zip .
          cd ..
          
          echo "模块创建完成！"
          ls -lh dfps-magisk-module.zip
        else
          echo "错误：未找到二进制文件"
          exit 1
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dfps-module
        path: |
          dfps-magisk-module.zip
          dfps
        retention-days: 7
